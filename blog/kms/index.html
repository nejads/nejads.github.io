<!doctype html><html dir=ltr lang=en data-theme class="html theme--light"><head><title>Sorosh Nejad
|
Key management service on AWS</title><meta charset=utf-8><meta name=generator content="Hugo 0.110.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=author content="Sorosh Nejad"><meta name=description content="Cloud engineer - Backend developer - AppSec speciallist"><link rel=stylesheet href=/scss/main.min.1147aa5bacb4bce677a0e264073829caedb82fd18ea07a5f1d80521f539d1c45.css integrity="sha256-EUeqW6y0vOZ3oOJkBzgpyu24L9GOoHpfHYBSH1OdHEU=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/markupHighlight.min.73ccfdf28df555e11009c13c20ced067af3cb021504cba43644c705930428b00.css integrity="sha256-c8z98o31VeEQCcE8IM7QZ688sCFQTLpDZExwWTBCiwA=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/fontawesome.min.7d272de35b410fb165377550cdf9c4d3a80fbbcc961e111914e4d5c0eaf5729f.css integrity="sha256-fSct41tBD7FlN3VQzfnE06gPu8yWHhEZFOTVwOr1cp8=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/solid.min.55d8333481b07a08e07cf6f37319753a2b47e99f4c395394c5747b48b495aa9b.css integrity="sha256-VdgzNIGwegjgfPbzcxl1OitH6Z9MOVOUxXR7SLSVqps=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/regular.min.a7448d02590b43449364b6b5922ed9af5410abb4de4238412a830316dedb850b.css integrity="sha256-p0SNAlkLQ0STZLa1ki7Zr1QQq7TeQjhBKoMDFt7bhQs=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/brands.min.9ed75a5d670c953fe4df935937674b4646f92674367e9e66eb995bb04e821647.css integrity="sha256-ntdaXWcMlT/k35NZN2dLRkb5JnQ2fp5m65lbsE6CFkc=" crossorigin=anonymous type=text/css><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=canonical href=https://nejads.github.io/blog/kms/><script type=text/javascript src=/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js integrity="sha256-+RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/anatole-theme-switcher.min.d6d329d93844b162e8bed1e915619625ca91687952177552b9b3e211014a2957.js integrity="sha256-1tMp2ThEsWLovtHpFWGWJcqRaHlSF3VSubPiEQFKKVc=" crossorigin=anonymous></script><meta name=twitter:card content="summary"><meta name=twitter:title content="Key management service on AWS"><meta name=twitter:description content="In this post we will discuss what Key Management System is and what are the main features of it. Furthermore, we will show how you can integrate KMS with Aws Lambda and migrate your signing and verification workload to the KMS service. At last, we will discuss a limitation on creating CSRs in the KMS service and a solution for it using Bouncycastle and Java. ðŸš€
What is KMS service The key management service (KMS) is a service for the creation and management of the cryptographic keys."><meta property="og:title" content="Key management service on AWS"><meta property="og:description" content="In this post we will discuss what Key Management System is and what are the main features of it. Furthermore, we will show how you can integrate KMS with Aws Lambda and migrate your signing and verification workload to the KMS service. At last, we will discuss a limitation on creating CSRs in the KMS service and a solution for it using Bouncycastle and Java. ðŸš€
What is KMS service The key management service (KMS) is a service for the creation and management of the cryptographic keys."><meta property="og:type" content="article"><meta property="og:url" content="https://nejads.github.io/blog/kms/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2020-07-16T17:15:18+02:00"><meta property="article:modified_time" content="2023-07-16T18:55:15+02:00"><meta property="og:site_name" content="Sorosh Nejad"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"blog","name":"Key management service on AWS","headline":"Key management service on AWS","alternativeHeadline":"","description":"
      
        In this post we will discuss what Key Management System is and what are the main features of it. Furthermore, we will show how you can integrate KMS with Aws Lambda and migrate your signing and verification workload to the KMS service. At last, we will discuss a limitation on creating CSRs in the KMS service and a solution for it using Bouncycastle and Java. ðŸš€\nWhat is KMS service The key management service (KMS) is a service for the creation and management of the cryptographic keys.


      


    ","inLanguage":"en-us","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/nejads.github.io\/blog\/kms\/"},"author":{"@type":"Person","name":"Sorosh Nejad"},"creator":{"@type":"Person","name":"Sorosh Nejad"},"accountablePerson":{"@type":"Person","name":"Sorosh Nejad"},"copyrightHolder":{"@type":"Person","name":"Sorosh Nejad"},"copyrightYear":"2020","dateCreated":"2020-07-16T17:15:18.00Z","datePublished":"2020-07-16T17:15:18.00Z","dateModified":"2023-07-16T18:55:15.00Z","publisher":{"@type":"Organization","name":"Sorosh Nejad","url":"https://nejads.github.io/","logo":{"@type":"ImageObject","url":"https:\/\/nejads.github.io\/favicon-32x32.png","width":"32","height":"32"}},"image":[],"url":"https:\/\/nejads.github.io\/blog\/kms\/","wordCount":"1267","genre":[],"keywords":[]}</script></head><body class=body><div class=wrapper><aside class=wrapper__sidebar><div class="sidebar
animated fadeInDown"><div class=sidebar__content><div class=sidebar__introduction><img class=sidebar__introduction-profileimage src=/images/profile2.jpg alt="profile picture"><div class=sidebar__introduction-title><a href=/>Sorosh Nejad</a></div><div class=sidebar__introduction-description><p>Cloud engineer - Backend developer - AppSec speciallist</p></div></div><ul class=sidebar__list><li class=sidebar__list-item><a href=https://github.com/nejads target=_blank rel="noopener me" aria-label=GitHub title=GitHub><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=mailto:nejads[@]me[.]com target=_blank rel="noopener me" aria-label=e-mail title=e-mail><i class="fas fa-envelope fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://linkedin.com/in/nejads/ target=_blank rel="noopener me" aria-label=LinkedIn title=LinkedIn><i class="fab fa-linkedin fa-2x" aria-hidden=true></i></a></li></ul></div><footer class="footer footer__sidebar"><ul class=footer__list><li class=footer__item>&copy;
Sorosh Nejad, 2015-2023</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script></div></aside><main class=wrapper__main><header class=header><div class="animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span></a><nav class=nav><ul class=nav__list id=navMenu><li class=nav__list-item><a href=/ title>Home</a></li><li class=nav__list-item><a href=/blog/ title>Blog</a></li><li class=nav__list-item><a href=https://github.com/nejads/til target=_blank rel="noopener noreferrer" title>Today I Learned</a></li><li class=nav__list-item><a href=about title>About</a></li><li class=nav__list-item><a href=/files/cv.pdf title>CV</a></li></ul><ul class="nav__list nav__list--end"><li class=nav__list-item><div class=themeswitch><a title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></li></ul></nav></div></header><div class="post
animated fadeInDown"><div class=post__content><h1>Key Management Service on AWS</h1><p>In this post we will discuss what Key Management System is and what are the main features of it. Furthermore, we will show how you can integrate KMS with Aws Lambda and migrate your signing and verification workload to the KMS service. At last, we will discuss a limitation on creating CSRs in the KMS service and a solution for it using Bouncycastle and Java. ðŸš€</p><h5 id=what-is-kms-service>What is KMS service</h5><p><a href=https://aws.amazon.com/kms>The key management service (KMS)</a> is a service for the creation and management of the cryptographic keys. You can create both symmetric keys as well as asymmetric key pairs to perform encryption, decryption, signing, and verification process in your applications. Signing and verify in AWS kms feature is <a href=https://aws.amazon.com/blogs/security/digital-signing-asymmetric-keys-aws-kms/>relatively new</a> compared to encryption and decryption.</p><h5 id=key-features>Key features</h5><p>KMS is a <a href=https://aws.amazon.com/kms/features/>fully managed</a> service and can integrate with plenty of AWS services easily. KMS uses a <a href=https://aws.amazon.com/kms/features/#Secure>hardware security module</a> to keep the cryptographic keys secure. AWS KMS is designed so that no one, including AWS employees, can retrieve your plaintext keys from the service.</p><h5 id=characteristic-of-the-key>Characteristic of the key</h5><p>For the propose of this post, I am using an EC key pair to sign my content with the private key of that key pair. More specifically, the &ldquo;key-spec&rdquo; I am using is an asymmetric <a href=https://tools.ietf.org/html/rfc5753>NIST-recommended</a> elliptic curve key pairs, EC_NIST_P256 for signing and verification. <a href=https://docs.aws.amazon.com/kms/latest/developerguide/symm-asymm-choose.html>On this page</a>, you can see which configuration is most suitable for your case.</p><h5 id=what-is-csr-and-why-we-need-to-create-one-csr>What is CSR and why we need to create one CSR</h5><p>Certificate Signing Request (CSR) is a message from an applicant to a certificate authority(CA). You normally apply for a digital certificate to a CA by sending them a CSR. The most common format for CSRs is the <a href=https://en.wikipedia.org/wiki/PKCS>PKCS</a>10 specification, usually represented as a Base64 encoded. A CSR usually consists of three parts:</p><ol><li>A subject including identity information like country, state, city, organization name, and so on.</li><li>The public key for which the certificate should be issued</li><li>A digital signature on point one and two. This integrity protection ensures the CA that nothing has changed in the communication channel.</li></ol><h3 id=kms-signer-application>Kms signer application</h3><p>Let&rsquo;s create an application to demonstrate how you can migrate your signing workload on KMS. I am using <a href=https://www.serverless.com/>Serverless framework</a> for creating my AWS resources. If you are not familar with this framework, take a look on <a href=https://www.serverless.com/framework/docs/getting-started/>this page</a></p><ul><li><p>Create a Aws Lambda</p><p>â€‹ <code>sls create -t "aws-java-maven" -n kms-signer</code></p></li></ul><h5 id=first-step-create-lambda-and-api-gateway>First step: Create lambda and API gateway</h5><ul><li><p>Add post method as a trigger to the lambda function in <code>serverless.yml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>events</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>path</span>: <span style=color:#ae81ff>sign</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>method</span>: <span style=color:#ae81ff>post</span>
</span></span></code></pre></div></li><li><p>Deploy</p><p>Congratulation! You created a lambda function and an API gateway for it. It is time to deploy it on AWS. Don&rsquo;t forget to build your project before deploy!</p><p>â€‹ <code>sls deploy</code></p></li><li><p>If the deploy goes well, you will get a link to your API in the logs. You can test the API using a REST client e.g. curl like following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl --location --request POST <span style=color:#e6db74>&#39;https://&lt;MYURL&gt;/dev/sign&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--header <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--data-raw <span style=color:#e6db74>&#39;{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	&#34;message&#34;: &#34;sign-this!&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}&#39;</span>
</span></span></code></pre></div><p>Ofcourse you get a default result which has created by Serverless framwork. In the next step we will put the application into context and send back an actual result from the API. You can read the logs on CloadWatch console, or easier using this command:</p><p>â€‹ <code>sls logs -f &lt;FUNCTION-NAME></code></p><h5 id=bonus>BONUS:</h5><p>Useful log messages that you can put in your lambda to observe system environment variables, context data, and event data are as following.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// log execution details
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>LOG<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ENVIRONMENT VARIABLES: {}&#34;</span><span style=color:#f92672>,</span> gson<span style=color:#f92672>.</span><span style=color:#a6e22e>toJson</span><span style=color:#f92672>(</span>System<span style=color:#f92672>.</span><span style=color:#a6e22e>getenv</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>LOG<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;CONTEXT: {}&#34;</span><span style=color:#f92672>,</span> gson<span style=color:#f92672>.</span><span style=color:#a6e22e>toJson</span><span style=color:#f92672>(</span>context<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// process event
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>LOG<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;EVENT: {}&#34;</span><span style=color:#f92672>,</span> gson<span style=color:#f92672>.</span><span style=color:#a6e22e>toJson</span><span style=color:#f92672>(</span>event<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>LOG<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;EVENT TYPE: {}&#34;</span><span style=color:#f92672>,</span> event<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span></code></pre></div></li></ul><h5 id=second-step-create-a-ec-key-pair>Second step: Create a EC key pair</h5><p>In the time of writing this post, CloudFormation does not currently support creating asymmetric CMKs. So we need to do it in the Console or Aws Command line tool. You can find a comprehensive description on how to create a CMK <a href=https://docs.aws.amazon.com/kms/latest/developerguide/create-keys.html#create-asymmetric-cmk>here</a></p><h5 id=third-step-add-iam-role>Third step: Add IAM Role</h5><p>The Lambda needs to have correct IAM ROLE to be able to access the CMK you have created in the previous step. To give access, you need something like following the IAM role statement in your serverless.yml.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>iamRoleStatements</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>Effect</span>: <span style=color:#e6db74>&#39;Allow&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Action</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>kms:GetPublicKey</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>kms:ListKeys</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>kms:ListResourceTags</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>kms:Sign</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Resource</span>: <span style=color:#e6db74>&#39;arn:aws:kms:&lt;REGION&gt;:&lt;ACCOUNT&gt;:key/&lt;KEY-ID&gt;&#39;</span>
</span></span></code></pre></div><h5 id=fourth-step-sign-a-string-using-kms>Fourth step: Sign a string using kms</h5><p>First of all you need to include <code>aws-java-sdk-kms</code> dependency to your project dependencies. Then, You need to define another function handler and corresponding API gateway for it. Finally, you create a method that gets a serilized object as an argument and send a sign request to the KMS. For example you can look into following example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> <span style=color:#a6e22e>sign</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> message<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> SignResult signResult <span style=color:#f92672>=</span> AWSKMSClientBuilder
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span><span style=color:#a6e22e>standard</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span><span style=color:#a6e22e>sign</span><span style=color:#f92672>(</span>getSignRequest<span style=color:#f92672>(</span>message<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> signResult<span style=color:#f92672>.</span><span style=color:#a6e22e>getSignature</span><span style=color:#f92672>().</span><span style=color:#a6e22e>array</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> SignRequest <span style=color:#a6e22e>getSignRequest</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> signingInput<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> hashedInput <span style=color:#f92672>=</span> DigestUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>sha256</span><span style=color:#f92672>(</span>signingInput<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> ByteBuffer message <span style=color:#f92672>=</span> ByteBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>wrap</span><span style=color:#f92672>(</span>hashedInput<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> SignRequest<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span><span style=color:#a6e22e>withMessage</span><span style=color:#f92672>(</span>message<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span><span style=color:#a6e22e>withMessageType</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;DIGEST&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span><span style=color:#a6e22e>withKeyId</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&lt;KEY-ID&gt;&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>.</span><span style=color:#a6e22e>withSigningAlgorithm</span><span style=color:#f92672>(</span>SigningAlgorithmSpec<span style=color:#f92672>.</span><span style=color:#a6e22e>ECDSA_SHA_256</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h5 id=fifth-step-create-a-csr-programmatically>Fifth step: Create a CSR programmatically</h5><p>So far, so good! You have an application that can sign content for you. You can send your signature and your public key to a third party entity, and that entity is able to verify your signature. One problem is remaining, though! What if an attacker forges your signature and public key. You need to ensure the other entities that your public key is authentic.</p><p>First, you apply for a certificate by sending a CA a CSR. The digital certificate you eventually get from the CA is confirming the authenticity of your public key. Traditionally, you create a CSR with OpenSSL tool with these steps:</p><ol><li><p>First generate a pair of keys:</p><p><code>openssl ecparam -out private.key -name prime256v1 -genkey</code></p></li><li><p>Then using these pair of key to generating a CSR. Note that you need private key for having a &ldquo;Applicant signature&rdquo; on your CSR</p><p><code>openssl req -new -key private.key -out my-csr.csr -sha256</code></p></li></ol><p>The issue in KMS is the CSR creation feature is not an available feature. Additionally, no one can have access to the private key generated on KMS. So this is a deadend way?</p><p>No, using the Bouncycastle, we are able to create a CSR. By using <code>PKCS10CertificationRequestBuilder</code> class from PKCS package, we create a &ldquo;pre-build&rdquo; CSR object which would need a <code>ContentSigner</code>. All we need to do is implement <code>ContentSigner</code> interface and glue the &ldquo;sign&rdquo; method we created before to this class.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AwsKMSContentSigner</span> <span style=color:#66d9ef>implements</span> ContentSigner <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ByteArrayOutputStream outputStream<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> AlgorithmIdentifier sigAlgId<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> AwsKmsSigner signer<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>AwsKMSContentSigner</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sigAlgId</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DefaultSignatureAlgorithmIdentifierFinder<span style=color:#f92672>().</span><span style=color:#a6e22e>find</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;SHA256WITHECDSA&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>outputStream</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ByteArrayOutputStream<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>signer</span> <span style=color:#f92672>=</span> AwsKmsSigner<span style=color:#f92672>.</span><span style=color:#a6e22e>getInstance</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> AlgorithmIdentifier <span style=color:#a6e22e>getAlgorithmIdentifier</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sigAlgId</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> OutputStream <span style=color:#a6e22e>getOutputStream</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>outputStream</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> <span style=color:#a6e22e>getSignature</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> signedAttributeSet <span style=color:#f92672>=</span> outputStream<span style=color:#f92672>.</span><span style=color:#a6e22e>toByteArray</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> signer<span style=color:#f92672>.</span><span style=color:#a6e22e>sign</span><span style=color:#f92672>(</span>signedAttributeSet<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Additionally, pass it to the PKCS builder. The builder uses the signer to generate the &ldquo;application signature&rdquo; on the CSR.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>createCsr</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  PKCS10CertificationRequestBuilder p10Builder <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JcaPKCS10CertificationRequestBuilder<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> X500Principal<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;CN=Signer, O=MyOrg, OU=MyOrgUnit, C=Gothenburg, L=Sweden&#34;</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>    getPublicKey<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  ContentSigner contentSigner <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AwsKMSContentSigner<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  PKCS10CertificationRequest csr <span style=color:#f92672>=</span> p10Builder<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>(</span>contentSigner<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  PemObject pemObject <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PemObject<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;CERTIFICATE REQUEST&#34;</span><span style=color:#f92672>,</span> csr<span style=color:#f92672>.</span><span style=color:#a6e22e>getEncoded</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>  StringWriter csrString <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StringWriter<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  JcaPEMWriter pemWriter <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JcaPEMWriter<span style=color:#f92672>(</span>csrString<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  pemWriter<span style=color:#f92672>.</span><span style=color:#a6e22e>writeObject</span><span style=color:#f92672>(</span>pemObject<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  pemWriter<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  csrString<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> csrString<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Done! The output is something similar to this:</p><pre tabindex=0><code>-----BEGIN CERTIFICATE REQUEST-----
MIIBKDCBzwIBADBtMQ8wDQYDVQQHEwZTd2VkZW4xEzARBgNVBAYTCkdvdGhlbmJ1
cmcxGzAZBgNVBAsTEk15T3JnYW5pemF0aW9uVW5pdDEXMBUGA1UEChMOTXlPcmdh
bml6YXRpb24xDzANBgNVBAMTBlNpZ25lcjBZMBMGByqGSM49AgEGCCqGSM49AwEH
A0IABEGM2IMVUC3edUwly1y+G+ufLXbCVj6Ee9Dqz/XFEV7goD2twHBok+kGQxqN
nYkgBDIw54F9JtWWEhSch8QIluCgADAKBggqhkjOPQQDAgNIADBFAiEA3WFMR7mg
nF4VqCh1sFoLoxoAdvZvRpAa/F4wyvJQjU0CIEVxatmlGXzmoBY/MKHPiXG2UKVu
0yOb6ZsZeFQoHHN1
-----END CERTIFICATE REQUEST-----
</code></pre><h5 id=verify-the-signature-in-csr>Verify the signature in CSR</h5><p>If you want to verify the digital signature inside a Certificate Signing Request, you can use the OpenSSL &ldquo;req -verify&rdquo; command as shown below:</p><p><code>openssl req -in myCsr.csr -noout -verify</code></p><p>The output &ldquo;verify OK&rdquo; indicates that the decrypted digital signature matches the digest of the CSR data.</p><h4 id=link-on-devto>Link on Dev.to</h4><p>You can find <a href=https://dev.to/nejad/key-management-service-on-aws-1e1m>this post on Dev</a></p><h5 id=useful-links>Useful links</h5><ul><li><a href=https://www.sslshopper.com/>SSL shopper</a></li><li><a href=https://certlogik.com/decoder/>Cert logik</a></li><li><a href=https://aws.amazon.com/blogs/security/digital-signing-asymmetric-keys-aws-kms/>Digital signing with kms</a></li></ul></div><div class=post__footer></div></div></main></div><footer class="footer footer__base"><ul class=footer__list><li class=footer__item>&copy;
Sorosh Nejad, 2015-2023</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script></body></html>